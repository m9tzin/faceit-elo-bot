name: CI - Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: Test & Validate (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest  # MÃ¡quina virtual Ubuntu
    
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸš€ Check if app starts
        run: |
          echo "Starting app with timeout of 10 seconds..."
          timeout 10s npm start || code=$?
          if [ ${code:-0} -eq 124 ]; then
            echo "âœ… App started successfully (timeout after 10s as expected)"
            exit 0
          else
            echo "âŒ App failed to start with exit code: ${code}"
            exit 1
          fi
        env:
          FACEIT_KEY: test_key_for_ci_pipeline
          PLAYER_NICKNAME: test_player
          PORT: 3000
      
      - name: ğŸ“‚ Verify project structure
        run: |
          echo "ğŸ” Checking if all required files exist..."
          
          # Verificar arquivos essenciais
          test -f package.json && echo "âœ… package.json found" || exit 1
          test -f src/index.js && echo "âœ… src/index.js found" || exit 1
          test -d src/routes && echo "âœ… src/routes/ directory found" || exit 1
          test -d src/services && echo "âœ… src/services/ directory found" || exit 1
          test -d src/middlewares && echo "âœ… src/middlewares/ directory found" || exit 1
          test -d src/utils && echo "âœ… src/utils/ directory found" || exit 1
          
          echo ""
          echo "ğŸ‰ Project structure is valid!"
      
      - name: ğŸ“‹ List route files
        run: |
          echo "ğŸ“ Available routes:"
          ls -la src/routes/
  
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ›¡ï¸ Run security audit
        run: |
          echo "ğŸ” Checking for security vulnerabilities..."
          npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilities found, but not blocking CI"
        continue-on-error: true  # NÃ£o falha o build se encontrar vulnerabilidades
      
      - name: ğŸ“Š Check for outdated dependencies
        run: |
          echo "ğŸ“¦ Checking for outdated packages..."
          npm outdated || true
          echo "â„¹ï¸ Run 'npm update' to update packages"

  build-status:
    name: âœ… Build Status Check
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - name: ğŸ‰ All checks passed
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸ‰ ALL CI CHECKS PASSED! ğŸ‰         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Tests: Passed on Node 18.x, 20.x, 22.x"
          echo "âœ… Security: Audit completed"
          echo "âœ… Project Structure: Valid"
          echo ""
          echo "ğŸš€ Ready to deploy or merge!"
          echo ""

